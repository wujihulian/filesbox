(function(){"use strict";function m(e){return function(n){function t(){return n.setDisabled(e.readonly||!s.hasHeaders(e))}return t(),e.on("LoadContent SetContent change",t),function(){return e.on("LoadContent SetContent change",t)}}}var T=tinymce.util.Tools.resolve("tinymce.PluginManager"),y=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),C=tinymce.util.Tools.resolve("tinymce.util.I18n"),b=tinymce.util.Tools.resolve("tinymce.util.Tools"),l=function(e){return e.getParam("toc_class","mce-toc")},v=function(e){var n=e.getParam("toc_header","h2");return/^h[1-6]$/.test(n)?n:"h2"},I=function(e){var n=parseInt(e.getParam("toc_depth","3"),10);return 1<=n&&n<=9?n:3},P=function(e){var n=0;return function(){var t=new Date().getTime().toString(32);return e+t+(n++).toString(32)}}("mcetoc_"),S=function(n){var t,o=[];for(t=1;t<=n;t++)o.push("h"+t);return o.join(",")},g=function(e){var n=l(e),t=v(e),o=S(I(e)),r=e.$(o);return r.length&&/^h[1-9]$/i.test(t)&&(r=r.filter(function(i,c){return!e.dom.hasClass(c.parentNode,n)})),b.map(r,function(i){return{id:i.id?i.id:P(),level:parseInt(i.nodeName.replace(/^H/i,""),10),title:e.$.text(i),element:i}})},h=function(e){var n,t,o,r,i="",c=g(e),f=function(d){var a,u=9;for(a=0;a<d.length;a++)if(d[a].level<u&&(u=d[a].level),u===1)return u;return u}(c)-1;if(!c.length)return"";for(i+=function(d,a){var u="</"+d+">";return"<"+d+' contenteditable="true">'+y.DOM.encode(a)+u}(v(e),C.translate("Table of Contents")),n=0;n<c.length;n++){if((o=c[n]).element.id=o.id,r=c[n+1]&&c[n+1].level,f===o.level)i+="<li>";else for(t=f;t<o.level;t++)i+="<ul><li>";if(i+='<a href="#'+o.id+'">'+o.title+"</a>",r!==o.level&&r)for(t=o.level;r<t;t--)i+="</li></ul><li>";else i+="</li>",r||(i+="</ul>");f=o.level}return i},p=function(e){var n=l(e),t=e.$("."+n);t.length&&e.undoManager.transact(function(){t.html(h(e))})},s={hasHeaders:function(e){return 0<g(e).length},insertToc:function(e){var n=l(e),t=e.$("."+n);(function(o,r){return!r.length||0<o.dom.getParents(r[0],".mce-offscreen-selection").length})(e,t)?e.insertContent(function(o){var r=h(o);return'<div class="'+o.dom.encode(l(o))+'" contenteditable="false">'+r+"</div>"}(e)):p(e)},updateToc:p},$=function(e){e.addCommand("mceInsertToc",function(){s.insertToc(e)}),e.addCommand("mceUpdateToc",function(){s.updateToc(e)})},x=function(e){var n=e.$,t=l(e);e.on("PreProcess",function(o){var r=n("."+t,o.node);r.length&&(r.removeAttr("contentEditable"),r.find("[contenteditable]").removeAttr("contentEditable"))}),e.on("SetContent",function(){var o=n("."+t);o.length&&(o.attr("contentEditable",!1),o.children(":first-child").attr("contentEditable",!0))})},A=function(e){e.ui.registry.addButton("toc",{icon:"toc",tooltip:"Table of contents",onAction:function(){return e.execCommand("mceInsertToc")},onSetup:m(e)}),e.ui.registry.addButton("tocupdate",{icon:"reload",tooltip:"Update",onAction:function(){return e.execCommand("mceUpdateToc")}}),e.ui.registry.addMenuItem("toc",{icon:"toc",text:"Table of contents",onAction:function(){return e.execCommand("mceInsertToc")},onSetup:m(e)}),e.ui.registry.addContextToolbar("toc",{items:"tocupdate",predicate:function(n){return function(t){return t&&n.dom.is(t,"."+l(n))&&n.getBody().contains(t)}}(e),scope:"node",position:"node"})};(function(){T.add("toc",function(n){$(n),A(n),x(n)})})()})();
