(function(D){"use strict";function x(n){return B({validate:!1,root_name:"#document"}).parse(n,{format:"xhtml"})}function A(n){return n.replace(/<\/?[A-Z]+/g,function(t){return t.toLowerCase()})}var k=function(n){function t(){return i}var i=n;return{get:t,set:function(l){i=l},clone:function(){return k(t())}}},E=tinymce.util.Tools.resolve("tinymce.PluginManager"),C=function(){return(C=Object.assign||function(n){for(var t,i=1,l=arguments.length;i<l;i++)for(var o in t=arguments[i])Object.prototype.hasOwnProperty.call(t,o)&&(n[o]=t[o]);return n}).apply(this,arguments)},s=tinymce.util.Tools.resolve("tinymce.util.Tools"),B=tinymce.util.Tools.resolve("tinymce.html.DomParser"),v=tinymce.util.Tools.resolve("tinymce.html.Node"),z=tinymce.util.Tools.resolve("tinymce.html.Serializer"),w=function(n){return n.getParam("fullpage_hide_in_source_view")},L=function(n){return n.getParam("fullpage_default_xml_pi")},P=function(n){return n.getParam("fullpage_default_encoding")},T=function(n){return n.getParam("fullpage_default_font_family")},O=function(n){return n.getParam("fullpage_default_font_size")},M=function(n){return n.getParam("fullpage_default_text_color")},S=function(n){return n.getParam("fullpage_default_title")},N=function(n){return n.getParam("fullpage_default_doctype","<!DOCTYPE html>")},q=x,F=function(n,t){var i,l,o=x(t),r={};function e(a,f){return a.attr(f)||""}return r.fontface=T(n),r.fontsize=O(n),(i=o.firstChild).type===7&&(r.xml_pi=!0,(l=/encoding="([^"]+)"/.exec(i.value))&&(r.docencoding=l[1])),(i=o.getAll("#doctype")[0])&&(r.doctype="<!DOCTYPE"+i.value+">"),(i=o.getAll("title")[0])&&i.firstChild&&(r.title=i.firstChild.value),s.each(o.getAll("meta"),function(a){var f,d=a.attr("name"),u=a.attr("http-equiv");d?r[d.toLowerCase()]=a.attr("content"):u==="Content-Type"&&(f=/charset\s*=\s*(.*)\s*/gi.exec(a.attr("content")))&&(r.docencoding=f[1])}),(i=o.getAll("html")[0])&&(r.langcode=e(i,"lang")||e(i,"xml:lang")),r.stylesheets=[],s.each(o.getAll("link"),function(a){a.attr("rel")==="stylesheet"&&r.stylesheets.push(a.attr("href"))}),(i=o.getAll("body")[0])&&(r.langdir=e(i,"dir"),r.style=e(i,"style"),r.visited_color=e(i,"vlink"),r.link_color=e(i,"link"),r.active_color=e(i,"alink")),r},Y=function(n,t,i){var l,o,r,e,a,f=n.dom;function d(c,p,g){c.attr(p,g||void 0)}function u(c){o.firstChild?o.insert(c,o.firstChild):o.append(c)}l=x(i),(o=l.getAll("head")[0])||(e=l.getAll("html")[0],o=new v("head",1),e.firstChild?e.insert(o,e.firstChild,!0):e.append(o)),e=l.firstChild,t.xml_pi?(a='version="1.0"',t.docencoding&&(a+=' encoding="'+t.docencoding+'"'),e.type!==7&&(e=new v("xml",7),l.insert(e,l.firstChild,!0)),e.value=a):e&&e.type===7&&e.remove(),e=l.getAll("#doctype")[0],t.doctype?(e||(e=new v("#doctype",10),t.xml_pi?l.insert(e,l.firstChild):u(e)),e.value=t.doctype.substring(9,t.doctype.length-1)):e&&e.remove(),e=null,s.each(l.getAll("meta"),function(c){c.attr("http-equiv")==="Content-Type"&&(e=c)}),t.docencoding?(e||((e=new v("meta",1)).attr("http-equiv","Content-Type"),e.shortEnded=!0,u(e)),e.attr("content","text/html; charset="+t.docencoding)):e&&e.remove(),e=l.getAll("title")[0],t.title?(e?e.empty():u(e=new v("title",1)),e.append(new v("#text",3)).value=t.title):e&&e.remove(),s.each("keywords,description,author,copyright,robots".split(","),function(c){var p,g,_=l.getAll("meta"),h=t[c];for(p=0;p<_.length;p++)if((g=_[p]).attr("name")===c)return void(h?g.attr("content",h):g.remove());h&&((e=new v("meta",1)).attr("name",c),e.attr("content",h),e.shortEnded=!0,u(e))});var y={};return s.each(l.getAll("link"),function(c){c.attr("rel")==="stylesheet"&&(y[c.attr("href")]=c)}),s.each(t.stylesheets,function(c){y[c]||((e=new v("link",1)).attr({rel:"stylesheet",text:"text/css",href:c}),e.shortEnded=!0,u(e)),delete y[c]}),s.each(y,function(c){c.remove()}),(e=l.getAll("body")[0])&&(d(e,"dir",t.langdir),d(e,"style",t.style),d(e,"vlink",t.visited_color),d(e,"link",t.link_color),d(e,"alink",t.active_color),f.setAttribs(n.getBody(),{style:t.style,dir:t.dir,vLink:t.visited_color,link:t.link_color,aLink:t.active_color})),(e=l.getAll("html")[0])&&(d(e,"lang",t.langcode),d(e,"xml:lang",t.langcode)),o.firstChild||o.remove(),(r=z({validate:!1,indent:!0,indent_before:"head,html,body,meta,title,script,link,style",indent_after:"head,html,body,meta,title,script,link,style"}).serialize(l)).substring(0,r.indexOf("</body>"))},j=function(n,t){var i=F(n,t.get()),l=C(C({},{title:"",keywords:"",description:"",robots:"",author:"",docencoding:""}),i);n.windowManager.open({title:"Metadata and Document Properties",size:"normal",body:{type:"panel",items:[{name:"title",type:"input",label:"Title"},{name:"keywords",type:"input",label:"Keywords"},{name:"description",type:"input",label:"Description"},{name:"robots",type:"input",label:"Robots"},{name:"author",type:"input",label:"Author"},{name:"docencoding",type:"input",label:"Encoding"}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0}],initialData:l,onSubmit:function(o){var r=o.getData(),e=Y(n,s.extend(i,r),t.get());t.set(e),o.close()}})},I=function(n,t){n.addCommand("mceFullPageProperties",function(){j(n,t)})},G=function(n,t){return s.each(n,function(i){t=t.replace(i,function(l){return"<!--mce:protected "+escape(l)+"-->"})}),t},K=function(n){return n.replace(/<!--mce:protected ([\s\S]*?)-->/g,function(t,i){return unescape(i)})},R=s.each,Z=function(n){var t,i="",l="";if(L(n)){var o=P(n);i+='<?xml version="1.0" encoding="'+(o||"ISO-8859-1")+`" ?>
`}return i+=N(n),i+=`
<html>
<head>
`,(t=S(n))&&(i+="<title>"+t+`</title>
`),(t=P(n))&&(i+='<meta http-equiv="Content-Type" content="text/html; charset='+t+`" />
`),(t=T(n))&&(l+="font-family: "+t+";"),(t=O(n))&&(l+="font-size: "+t+";"),(t=M(n))&&(l+="color: "+t+";"),i+=`</head>
<body`+(l?' style="'+l+'"':"")+`>
`},$=function(n,t,i){n.on("BeforeSetContent",function(l){(function(o,r,e,a){var f,d,u,y,c="",p=o.dom;if(!(a.selection||(u=G(o.settings.protect,a.content),a.format==="raw"&&r.get()||a.source_view&&w(o)))){u.length!==0||a.source_view||(u=s.trim(r.get())+`
`+s.trim(u)+`
`+s.trim(e.get())),(f=(u=u.replace(/<(\/?)BODY/gi,"<$1body")).indexOf("<body"))!==-1?(f=u.indexOf(">",f),r.set(A(u.substring(0,f+1))),(d=u.indexOf("</body",f))===-1&&(d=u.length),a.content=s.trim(u.substring(f+1,d)),e.set(A(u.substring(d)))):(r.set(Z(o)),e.set(`
</body>
</html>`)),y=q(r.get()),R(y.getAll("style"),function(m){m.firstChild&&(c+=m.firstChild.value)});var g=y.getAll("body")[0];g&&p.setAttribs(o.getBody(),{style:g.attr("style")||"",dir:g.attr("dir")||"",vLink:g.attr("vlink")||"",link:g.attr("link")||"",aLink:g.attr("alink")||""}),p.remove("fullpage_styles");var _=o.getDoc().getElementsByTagName("head")[0];c&&p.add(_,"style",{id:"fullpage_styles"}).appendChild(D.document.createTextNode(c));var h={};s.each(_.getElementsByTagName("link"),function(m){m.rel==="stylesheet"&&m.getAttribute("data-mce-fullpage")&&(h[m.href]=m)}),s.each(y.getAll("link"),function(m){var b=m.attr("href");if(!b)return!0;h[b]||m.attr("rel")!=="stylesheet"||p.add(_,"link",{rel:"stylesheet",text:"text/css",href:b,"data-mce-fullpage":"1"}),delete h[b]}),s.each(h,function(m){m.parentNode.removeChild(m)})}})(n,t,i,l)}),n.on("GetContent",function(l){(function(o,r,e,a){a.selection||a.source_view&&w(o)||(a.content=K(s.trim(r)+`
`+s.trim(a.content)+`
`+s.trim(e)))})(n,t.get(),i.get(),l)})},H=function(n){n.ui.registry.addButton("fullpage",{tooltip:"Metadata and document properties",icon:"document-properties",onAction:function(){n.execCommand("mceFullPageProperties")}}),n.ui.registry.addMenuItem("fullpage",{text:"Metadata and document properties",icon:"document-properties",onAction:function(){n.execCommand("mceFullPageProperties")}})};(function(){E.add("fullpage",function(t){var i=k(""),l=k("");I(t,i),H(t),$(t,i,l)})})()})(window);
