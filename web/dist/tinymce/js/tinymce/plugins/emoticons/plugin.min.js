(function(h){"use strict";function M(){}function p(t){return function(){return t}}function O(){return k}var j,U=tinymce.util.Tools.resolve("tinymce.PluginManager"),v=p(!1),C=p(!0),k=(j={fold:function(t,n){return t()},is:v,isSome:v,isNone:C,getOr:x,getOrThunk:S,getOrDie:function(t){throw new Error(t||"error: getOrDie called on none.")},getOrNull:p(null),getOrUndefined:p(void 0),or:x,orThunk:S,map:O,each:M,bind:O,exists:v,forall:C,filter:O,equals:D,equals_:D,toArray:function(){return[]},toString:p("none()")},Object.freeze&&Object.freeze(j),j);function D(t){return t.isNone()}function S(t){return t()}function x(t){return t}function L(t,n){return t.indexOf(n)!==-1}function R(t,n){return L(t.title.toLowerCase(),n)||function(e,r){for(var i=0,o=e.length;i<o;i++)if(r(e[i],i))return!0;return!1}(t.keywords,function(e){return L(e.toLowerCase(),n)})}function T(t,n,e){for(var r=[],i=n.toLowerCase(),o=e.fold(function(){return v},function(s){return function(a){return s<=a}}),l=0;l<t.length&&(n.length!==0&&!R(t[l],i)||(r.push({value:t[l].char,text:t[l].title,icon:t[l].char}),!o(r.length)));l++);return r}function N(t,n){for(var e=z(t),r=0,i=e.length;r<i;r++){var o=e[r];n(t[o],o)}}function B(t,n){return function(e,r){return V.call(e,r)}(t,n)?t[n]:n}function G(t){return function(n,e){return W(n,function(r,i){return{k:i,v:e(r,i)}})}($(t),function(n){return q({keywords:[],category:"user"},n)})}function H(t,n,e){var r=w(d.none()),i=w(d.none());t.on("init",function(){X.load(e,n).then(function(s){var a=G(t);(function(c){var u={},f=[];N(c,function(m,g){var y={title:g,keywords:m.keywords,char:m.char,category:B(tt,m.category)},rt=u[y.category]!==void 0?u[y.category]:[];u[y.category]=rt.concat([y]),f.push(y)}),r.set(d.some(u)),i.set(d.some(f))})(Q(s,a))},function(s){h.console.log("Failed to load emoticons: "+s),r.set(d.some({})),i.set(d.some([]))})});var o=function(){return i.get().getOr([])},l=function(){return r.get().isSome()&&i.get().isSome()};return{listCategories:function(){return[A].concat(z(r.get().getOr({})))},hasLoaded:l,waitForLoad:function(){return l()?I.resolve(!0):new I(function(s,a){var c=15,u=P.setInterval(function(){l()?(P.clearInterval(u),s(!0)):--c<0&&(h.console.log("Could not load emojis from url: "+n),P.clearInterval(u),a(!1))},100)})},listAll:o,listCategory:function(s){return s===A?o():r.get().bind(function(a){return d.from(a[s])}).getOr([])}}}var E,F,_=function(t){function n(){return i}function e(o){return o(t)}var r=p(t),i={fold:function(o,l){return l(t)},is:function(o){return t===o},isSome:C,isNone:v,getOr:r,getOrThunk:r,getOrDie:r,getOrNull:r,getOrUndefined:r,or:n,orThunk:n,map:function(o){return _(o(t))},each:function(o){o(t)},bind:e,exists:e,forall:e,filter:function(o){return o(t)?i:k},toArray:function(){return[t]},toString:function(){return"some("+t+")"},equals:function(o){return o.is(t)},equals_:function(o,l){return o.fold(v,function(s){return l(t,s)})}};return i},d={some:_,none:O,from:function(t){return t==null?k:_(t)}},J=(E="function",function(t){return function(n){if(n===null)return"null";var e=typeof n;return e=="object"&&(Array.prototype.isPrototypeOf(n)||n.constructor&&n.constructor.name==="Array")?"array":e=="object"&&(String.prototype.isPrototypeOf(n)||n.constructor&&n.constructor.name==="String")?"string":e}(t)===E}),ot=Array.prototype.slice,w=(J(Array.from)&&Array.from,function(t){function n(){return e}var e=t;return{get:n,set:function(r){e=r},clone:function(){return w(n())}}}),q=function(){return(q=Object.assign||function(t){for(var n,e=1,r=arguments.length;e<r;e++)for(var i in n=arguments[e])Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i]);return t}).apply(this,arguments)},K=Object.prototype.hasOwnProperty,Q=(F=function(t,n){return n},function(){for(var t=new Array(arguments.length),n=0;n<t.length;n++)t[n]=arguments[n];if(t.length===0)throw new Error("Can't merge zero objects");for(var e={},r=0;r<t.length;r++){var i=t[r];for(var o in i)K.call(i,o)&&(e[o]=F(e[o],i[o]))}return e}),z=Object.keys,V=Object.hasOwnProperty,W=function(t,n){var e={};return N(t,function(r,i){var o=n(r,i);e[o.k]=o.v}),e},X=tinymce.util.Tools.resolve("tinymce.Resource"),P=tinymce.util.Tools.resolve("tinymce.util.Delay"),I=tinymce.util.Tools.resolve("tinymce.util.Promise"),Y=function(t,n){return t.getParam("emoticons_database_url",n+"/js/emojis"+t.suffix+".js")},Z=function(t){return t.getParam("emoticons_database_id","tinymce.plugins.emoticons","string")},$=function(t){return t.getParam("emoticons_append",{},"object")},A="All",tt={symbols:"Symbols",people:"People",animals_and_nature:"Animals and Nature",food_and_drink:"Food and Drink",activity:"Activity",travel_and_places:"Travel and Places",objects:"Objects",flags:"Flags",user:"User Defined"},b="pattern",nt=function(t,n){function e(){return{title:"Emoticons",size:"normal",body:{type:"tabpanel",tabs:function(c,u){for(var f=c.length,m=new Array(f),g=0;g<f;g++){var y=c[g];m[g]=u(y,g)}return m}(n.listCategories(),function(c){return{title:c,name:c,items:[l,s]}})},initialData:r,onTabChange:function(c,u){i.set(u.newTabName),o.throttle(c)},onChange:o.throttle,onAction:function(c,u){u.name==="results"&&(function(f,m){f.insertContent(m)}(t,u.value),c.close())},buttons:[{type:"cancel",text:"Close",primary:!0}]}}var r={pattern:"",results:T(n.listAll(),"",d.some(300))},i=w(A),o=function(c,u){var f=null;return{cancel:function(){f!==null&&(h.clearTimeout(f),f=null)},throttle:function(){for(var m=[],g=0;g<arguments.length;g++)m[g]=arguments[g];f!==null&&h.clearTimeout(f),f=h.setTimeout(function(){c.apply(null,m),f=null},u)}}}(function(c){(function(u){var f=u.getData(),m=i.get(),g=n.listCategory(m),y=T(g,f[b],m===A?d.some(300):d.none());u.setData({results:y})})(c)},200),l={label:"Search",type:"input",name:b},s={type:"collection",name:"results"},a=t.windowManager.open(e());a.focus(b),n.hasLoaded()||(a.block("Loading emoticons..."),n.waitForLoad().then(function(){a.redial(e()),o.throttle(a),a.focus(b),a.unblock()}).catch(function(c){a.redial({title:"Emoticons",body:{type:"panel",items:[{type:"alertbanner",level:"error",icon:"warning",text:"<p>Could not load emoticons</p>"}]},buttons:[{type:"cancel",text:"Close",primary:!0}],initialData:{pattern:"",results:[]}}),a.focus(b),a.unblock()}))},et=function(t,n){function e(){return nt(t,n)}t.ui.registry.addButton("emoticons",{tooltip:"Emoticons",icon:"emoji",onAction:e}),t.ui.registry.addMenuItem("emoticons",{text:"Emoticons...",icon:"emoji",onAction:e})};(function(){U.add("emoticons",function(n,e){var r=Y(n,e),i=Z(n),o=H(n,r,i);et(n,o),function(l,s){l.ui.registry.addAutocompleter("emoticons",{ch:":",columns:"auto",minChars:2,fetch:function(a,c){return s.waitForLoad().then(function(){var u=s.listAll();return T(u,a,d.some(c))})},onAction:function(a,c,u){l.selection.setRng(c),l.insertContent(u),a.hide()}})}(n,o)})})()})(window);
