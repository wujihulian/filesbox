(function(N){"use strict";var $=function(n){function t(){return e}var e=n;return{get:t,set:function(r){e=r},clone:function(){return $(t())}}},jn=tinymce.util.Tools.resolve("tinymce.PluginManager"),P=function(){return(P=Object.assign||function(n){for(var t,e=1,r=arguments.length;e<r;e++)for(var o in t=arguments[e])Object.prototype.hasOwnProperty.call(t,o)&&(n[o]=t[o]);return n}).apply(this,arguments)};function nn(){}function v(n){return function(){return n}}function Bn(n){return n}function B(){return G}var F,y=v(!1),x=v(!0),G=(F={fold:function(n,t){return n()},is:y,isSome:y,isNone:x,getOr:rn,getOrThunk:en,getOrDie:function(n){throw new Error(n||"error: getOrDie called on none.")},getOrNull:v(null),getOrUndefined:v(void 0),or:rn,orThunk:en,map:B,each:nn,bind:B,exists:y,forall:x,filter:B,equals:tn,equals_:tn,toArray:function(){return[]},toString:v("none()")},Object.freeze&&Object.freeze(F),F);function tn(n){return n.isNone()}function en(n){return n()}function rn(n){return n}function D(n){return function(t){return function(e){if(e===null)return"null";var r=typeof e;return r=="object"&&(Array.prototype.isPrototypeOf(e)||e.constructor&&e.constructor.name==="Array")?"array":r=="object"&&(String.prototype.isPrototypeOf(e)||e.constructor&&e.constructor.name==="String")?"string":r}(t)===n}}function on(n,t){return-1<function(e,r){return Kn.call(e,r)}(n,t)}function I(n,t){for(var e=n.length,r=new Array(e),o=0;o<e;o++){var a=n[o];r[o]=t(a,o)}return r}function w(n,t){for(var e=0,r=n.length;e<r;e++)t(n[e],e)}function an(n,t){for(var e=[],r=0,o=n.length;r<o;r++){var a=n[r];t(a,r)&&e.push(a)}return e}function un(n,t,e){return function(r,o){for(var a=r.length-1;0<=a;a--)o(r[a],a)}(n,function(r){e=t(e,r)}),e}function fn(n,t){for(var e=0,r=n.length;e<r;++e)if(t(n[e],e)!==!0)return!1;return!0}function cn(n){var t=[],e=[];return w(n,function(r){r.fold(function(o){t.push(o)},function(o){e.push(o)})}),{errors:t,values:e}}function Dn(n){return n.type==="inline-command"||n.type==="inline-format"}function In(n){return n.type==="block-command"||n.type==="block-format"}function _n(n){return function(t,e){var r=Jn.call(t,0);return r.sort(e),r}(n,function(t,e){return t.start.length===e.start.length?0:t.start.length>e.start.length?-1:1})}function sn(n){function t(a){return L.error({message:a,pattern:n})}function e(a,i,u){if(n.format===void 0)return n.cmd!==void 0?E(n.cmd)?L.value(u(n.cmd,n.value)):t(a+" pattern has non-string `cmd` parameter"):t(a+" pattern is missing both `format` and `cmd` parameters");var f=void 0;if(S(n.format)){if(!fn(n.format,E))return t(a+" pattern has non-string items in the `format` array");f=n.format}else{if(!E(n.format))return t(a+" pattern has non-string `format` parameter");f=[n.format]}return L.value(i(f))}if(!Gn(n))return t("Raw pattern is not an object");if(!E(n.start))return t("Raw pattern is missing `start` parameter");if(n.end===void 0)return n.replacement!==void 0?E(n.replacement)?n.start.length===0?t("Replacement pattern has empty `start` parameter"):L.value({type:"inline-command",start:"",end:n.start,cmd:"mceInsertContent",value:n.replacement}):t("Replacement pattern has non-string `replacement` parameter"):n.start.length===0?t("Block pattern has empty `start` parameter"):e("Block",function(a){return{type:"block-format",start:n.start,format:a[0]}},function(a,i){return{type:"block-command",start:n.start,cmd:a,value:i}});if(!E(n.end))return t("Inline pattern has non-string `end` parameter");if(n.start.length===0&&n.end.length===0)return t("Inline pattern has empty `start` and `end` parameters");var r=n.start,o=n.end;return o.length===0&&(o=r,r=""),e("Inline",function(a){return{type:"inline-format",start:r,end:o,format:a}},function(a,i){return{type:"inline-command",start:r,end:o,cmd:a,value:i}})}function ln(n){return n.type==="block-command"?{start:n.start,cmd:n.cmd,value:n.value}:n.type==="block-format"?{start:n.start,format:n.format}:n.type==="inline-command"?n.cmd==="mceInsertContent"&&n.start===""?{start:n.end,replacement:n.value}:{start:n.start,end:n.end,cmd:n.cmd,value:n.value}:n.type==="inline-format"?{start:n.start,end:n.end,format:n.format.length===1?n.format[0]:n.format}:void 0}function dn(n){return{inlinePatterns:an(n,Dn),blockPatterns:_n(an(n,In))}}function mn(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];var e=Yn.console;e&&(e.error?e.error.apply(e,n):e.log.apply(e,n))}function Un(n){var t=function(r,o){return Tn(r,o)?s.from(r[o]):s.none()}(n,"textpattern_patterns").getOr(Zn);if(!S(t))return mn("The setting textpattern_patterns should be an array"),{inlinePatterns:[],blockPatterns:[]};var e=cn(I(t,sn));return w(e.errors,function(r){return mn(r.message,r.pattern)}),dn(e.values)}function gn(n){var t=n.getParam("forced_root_block","p");return t===!1?"":t===!0?"p":t}function k(n,t){return{container:n,offset:t}}function O(n){return n.nodeType===N.Node.TEXT_NODE}function _(n,t,e,r){r===void 0&&(r=!0);var o=t.startContainer.parentNode,a=t.endContainer.parentNode;t.deleteContents(),r&&!e(t.startContainer)&&(O(t.startContainer)&&t.startContainer.data.length===0&&n.remove(t.startContainer),O(t.endContainer)&&t.endContainer.data.length===0&&n.remove(t.endContainer),T(n,o,e),o!==a&&T(n,a,e))}function qn(n,t){var e=t.get(n);return S(e)&&function(r){return r.length===0?s.none():s.some(r[0])}(e).exists(function(r){return Tn(r,"block")})}function H(n){return n.start.length===0}function J(n,t){var e=s.from(n.dom.getParent(t.startContainer,n.dom.isBlock));return gn(n)===""?e.orThunk(function(){return s.some(n.getBody())}):e}function U(n){return function(t){return n===t?-1:0}}function K(n,t,e){if(O(n)&&0<=t)return s.some(k(n,t));var r=A(V);return s.from(r.backwards(n,t,U(n),e)).map(function(o){return k(o.container,o.container.data.length)})}function Ln(n,t,e,r,o){var a=A(n,function(i){return function(u){return i.isBlock(u)||on(["BR","IMG","HR","INPUT"],u.nodeName)||i.getContentEditable(u)==="false"}}(n));return s.from(a.backwards(t,e,r,o))}function pn(n,t,e){if(O(t)&&(e<0||e>t.data.length))return[];for(var r=[e],o=t;o!==n&&o.parentNode;){for(var a=o.parentNode,i=0;i<a.childNodes.length;i++)if(a.childNodes[i]===o){r.push(i);break}o=a}return o===n?r.reverse():[]}function X(n,t,e,r,o){return{start:pn(n,t,e),end:pn(n,r,o)}}function hn(n,t){var e=t.slice(),r=e.pop();return function(o,a,i){return w(o,function(u){i=a(i,u)}),i}(e,function(o,a){return o.bind(function(i){return s.from(i.childNodes[a])})},s.some(n)).bind(function(o){return O(o)&&0<=r&&o.data.length,s.some({node:o,offset:r})})}function vn(n,t){return hn(n,t.start).bind(function(e){var r=e.node,o=e.offset;return hn(n,t.end).map(function(a){var i=a.node,u=a.offset,f=N.document.createRange();return f.setStart(r,o),f.setEnd(i,u),f})})}function yn(n,t,e){(function(r,o,a){if(O(r)&&o>=r.length)return s.some(k(r,o));var i=A(V);return s.from(i.forwards(r,o,U(r),a)).map(function(u){return k(u.container,0)})})(t,0,t).each(function(r){var o=r.container;Pn(o,e.start.length,t).each(function(a){var i=n.createRng();i.setStart(o,0),i.setEnd(a.container,a.offset),_(n,i,function(u){return u===t})})})}function Vn(n,t){var e=t.replace("\xA0"," ");return function(r,o){for(var a=0,i=r.length;a<i;a++){var u=r[a];if(o(u,a))return s.some(u)}return s.none()}(n,function(r){return t.indexOf(r.start)===0||e.indexOf(r.start)===0})}function Wn(n,t){if(t.length!==0){var e=n.selection.getBookmark();w(t,function(r){return function(o,a){var i=o.dom,u=a.pattern,f=vn(i.getRoot(),a.range).getOrDie("Unable to resolve path range");return J(o,f).each(function(c){u.type==="block-format"?qn(u.format,o.formatter)&&o.undoManager.transact(function(){yn(o.dom,c,u),o.formatter.apply(u.format)}):u.type==="block-command"&&o.undoManager.transact(function(){yn(o.dom,c,u),o.execCommand(u.cmd,!1,u.value)})}),!0}(n,r)}),n.selection.moveToBookmark(e)}}function bn(n,t){return n.create("span",{"data-mce-type":"bookmark",id:t})}function q(n,t){var e=n.createRng();return e.setStartAfter(t.start),e.setEndBefore(t.end),e}function kn(n,t,e){var r=vn(n.getRoot(),e).getOrDie("Unable to resolve path range"),o=r.startContainer,a=r.endContainer,i=r.endOffset===0?a:a.splitText(r.endOffset),u=r.startOffset===0?o:o.splitText(r.startOffset);return{prefix:t,end:i.parentNode.insertBefore(bn(n,t+"-end"),i),start:u.parentNode.insertBefore(bn(n,t+"-start"),u)}}function On(n,t,e){T(n,n.get(t.prefix+"-end"),e),T(n,n.get(t.prefix+"-start"),e)}function zn(n,t,e){var r=n.dom,o=r.getRoot(),a=e.pattern,i=e.position.container,u=e.position.offset;return Y(i,u-e.pattern.end.length,t).bind(function(f){var c=X(o,f.container,f.offset,i,u);if(H(a))return s.some({matches:[{pattern:a,startRng:c,endRng:c}],position:f});var l=Mn(n,e.remainingPatterns,f.container,f.offset,t),d=l.getOr({matches:[],position:f}),m=d.position;return function(g,b,h,p,C,W){if(W===void 0&&(W=!1),b.start.length!==0||W)return K(h,p,C).bind(function(z){return Sn(g,b,C,z).bind(function(j){return W&&(j.endContainer===z.container&&j.endOffset===z.offset||z.offset===0&&j.endContainer.textContent.length===j.endOffset)?s.none():s.some(j)})});var Z=g.createRng();return Z.setStart(h,p),Z.setEnd(h,p),s.some(Z)}(r,a,m.container,m.offset,t,l.isNone()).map(function(g){var b=function(h,p){return X(h,p.startContainer,p.startOffset,p.endContainer,p.endOffset)}(o,g);return{matches:d.matches.concat([{pattern:a,startRng:b,endRng:c}]),position:k(g.startContainer,g.startOffset)}})})}function wn(n,t,e){n.selection.setRng(e),t.type==="inline-format"?w(t.format,function(r){n.formatter.apply(r)}):n.execCommand(t.cmd,!1,t.value)}function Fn(n,t){var e=function(o){var a=new Date().getTime();return o+"_"+Math.floor(1e9*Math.random())+ ++et+String(a)}("mce_textpattern"),r=un(t,function(o,a){var i=kn(n,e+"_end"+o.length,a.endRng);return o.concat([P(P({},a),{endMarker:i})])},[]);return un(r,function(o,a){var i=r.length-o.length-1,u=H(a.pattern)?a.endMarker:kn(n,e+"_start"+i,a.startRng);return o.concat([P(P({},a),{startMarker:u})])},[])}function Cn(n,t,e){var r=n.selection.getRng();return r.collapsed===!1?[]:J(n,r).bind(function(o){var a=r.startOffset-(e?1:0);return Mn(n,t,r.startContainer,a,o)}).fold(function(){return[]},function(o){return o.matches})}function xn(n,t){if(t.length!==0){var e=n.dom,r=n.selection.getBookmark(),o=Fn(e,t);w(o,function(a){function i(f){return f===u}var u=e.getParent(a.startMarker.start,e.isBlock);H(a.pattern)?function(f,c,l,d){var m=q(f.dom,l);_(f.dom,m,d),wn(f,c,m)}(n,a.pattern,a.endMarker,i):function(f,c,l,d,m){var g=f.dom,b=q(g,d),h=q(g,l);_(g,h,m),_(g,b,m);var p={prefix:l.prefix,start:l.end,end:d.start},C=q(g,p);wn(f,c,C)}(n,a.pattern,a.startMarker,a.endMarker,i),On(e,a.endMarker,i),On(e,a.startMarker,i)}),n.selection.moveToBookmark(r)}}function En(n,t,e){for(var r=0;r<n.length;r++)if(e(n[r],t))return!0}var Q=function(n){function t(){return o}function e(a){return a(n)}var r=v(n),o={fold:function(a,i){return i(n)},is:function(a){return n===a},isSome:x,isNone:y,getOr:r,getOrThunk:r,getOrDie:r,getOrNull:r,getOrUndefined:r,or:t,orThunk:t,map:function(a){return Q(a(n))},each:function(a){a(n)},bind:e,exists:e,forall:e,filter:function(a){return a(n)?o:G},toArray:function(){return[n]},toString:function(){return"some("+n+")"},equals:function(a){return a.is(n)},equals_:function(a,i){return a.fold(y,function(u){return i(n,u)})}};return o},s={some:Q,none:B,from:function(n){return n==null?G:Q(n)}},E=D("string"),Gn=D("object"),S=D("array"),Hn=D("function"),Jn=Array.prototype.slice,Kn=Array.prototype.indexOf,Rn=(Hn(Array.from)&&Array.from,Object.keys),Xn=Object.hasOwnProperty,Tn=function(n,t){return Xn.call(n,t)},R=(function(n){if(!S(n))throw new Error("cases must be an array");if(n.length===0)throw new Error("there must be at least one case");var t=[],e={};w(n,function(r,o){var a=Rn(r);if(a.length!==1)throw new Error("one and only one name per case");var i=a[0],u=r[i];if(e[i]!==void 0)throw new Error("duplicate key detected:"+i);if(i==="cata")throw new Error("cannot have a case named cata (sorry)");if(!S(u))throw new Error("case arguments must be an array");t.push(i),e[i]=function(){var f=arguments.length;if(f!==u.length)throw new Error("Wrong number of arguments to case "+i+". Expected "+u.length+" ("+u+"), got "+f);for(var c=new Array(f),l=0;l<c.length;l++)c[l]=arguments[l];return{fold:function(){if(arguments.length!==n.length)throw new Error("Wrong number of arguments to fold. Expected "+n.length+", got "+arguments.length);return arguments[o].apply(null,c)},match:function(d){var m=Rn(d);if(t.length!==m.length)throw new Error("Wrong number of arguments to match. Expected: "+t.join(",")+`
Actual: `+m.join(","));if(!fn(t,function(g){return on(m,g)}))throw new Error("Not all branches were specified when using match. Specified: "+m.join(", ")+`
Required: `+t.join(", "));return d[i].apply(null,c)},log:function(d){N.console.log(d,{constructors:t,constructor:i,params:c})}}}})}([{bothErrors:["error1","error2"]},{firstError:["error1","value2"]},{secondError:["value1","error2"]},{bothValues:["value1","value2"]}]),function(n){return{is:function(t){return n===t},isValue:x,isError:y,getOr:v(n),getOrThunk:v(n),getOrDie:v(n),or:function(t){return R(n)},orThunk:function(t){return R(n)},fold:function(t,e){return e(n)},map:function(t){return R(t(n))},mapError:function(t){return R(n)},each:function(t){t(n)},bind:function(t){return t(n)},exists:function(t){return t(n)},forall:function(t){return t(n)},toOption:function(){return s.some(n)}}}),M=function(n){return{is:y,isValue:y,isError:x,getOr:Bn,getOrThunk:function(t){return t()},getOrDie:function(){return function(t){return function(){throw new Error(t)}}(String(n))()},or:function(t){return t},orThunk:function(t){return t()},fold:function(t,e){return t(n)},map:function(t){return M(n)},mapError:function(t){return M(t(n))},each:nn,bind:function(t){return M(n)},exists:y,forall:x,toOption:s.none}},L={value:R,error:M,fromOption:function(n,t){return n.fold(function(){return M(t)},R)}},Qn=function(n){return{setPatterns:function(t){var e=cn(I(t,sn));if(0<e.errors.length){var r=e.errors[0];throw new Error(r.message+`:
`+JSON.stringify(r.pattern,null,2))}n.set(dn(e.values))},getPatterns:function(){return function(){for(var e=0,r=0,o=arguments.length;r<o;r++)e+=arguments[r].length;var a=Array(e),i=0;for(r=0;r<o;r++)for(var u=arguments[r],f=0,c=u.length;f<c;f++,i++)a[i]=u[f];return a}(I(n.get().inlinePatterns,ln),I(n.get().blockPatterns,ln))}}},Yn=typeof N.window!="undefined"?N.window:Function("return this;")(),Zn=[{start:"*",end:"*",format:"italic"},{start:"**",end:"**",format:"bold"},{start:"#",format:"h1"},{start:"##",format:"h2"},{start:"###",format:"h3"},{start:"####",format:"h4"},{start:"#####",format:"h5"},{start:"######",format:"h6"},{start:"1. ",cmd:"InsertOrderedList"},{start:"* ",cmd:"InsertUnorderedList"},{start:"- ",cmd:"InsertUnorderedList"}],$n=tinymce.util.Tools.resolve("tinymce.util.Delay"),Nn=tinymce.util.Tools.resolve("tinymce.util.VK"),nt=tinymce.util.Tools.resolve("tinymce.util.Tools"),tt=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),A=tinymce.util.Tools.resolve("tinymce.dom.TextSeeker"),T=function(n,t,e){if(t&&n.isEmpty(t)&&!e(t)){var r=t.parentNode;n.remove(t),T(n,r,e)}},V=tt.DOM,Y=function(n,t,e){if(!O(n))return s.none();var r=n.textContent;if(0<=t&&t<=r.length)return s.some(k(n,t));var o=A(V);return s.from(o.backwards(n,t,U(n),e)).bind(function(a){var i=a.container.data;return Y(a.container,t+i.length,e)})},Pn=function(n,t,e){if(!O(n))return s.none();var r=n.textContent;if(t<=r.length)return s.some(k(n,t));var o=A(V);return s.from(o.forwards(n,t,U(n),e)).bind(function(a){return Pn(a.container,t-r.length,e)})},et=0,Sn=function(n,t,e,r){var o=t.start;return Ln(n,r.container,r.offset,function(a,i,u){return function(f,c){var l=f.data.substring(0,c),d=l.lastIndexOf(u.charAt(u.length-1)),m=l.lastIndexOf(u);return m!==-1?m+u.length:d!==-1?d+1:-1}}(0,0,o),e).bind(function(a){if(a.offset>=o.length){var i=n.createRng();return i.setStart(a.container,a.offset-o.length),i.setEnd(a.container,a.offset),s.some(i)}var u=a.offset-o.length;return Y(a.container,u,e).map(function(f){var c=n.createRng();return c.setStart(f.container,f.offset),c.setEnd(a.container,a.offset),c}).filter(function(f){return f.toString()===o}).orThunk(function(){return Sn(n,t,e,k(a.container,0))})})},Mn=function(n,t,e,r,o){var a=n.dom;return K(e,r,a.getRoot()).bind(function(i){var u=a.createRng();u.setStart(o,0),u.setEnd(e,r);for(var f,c,l=u.toString(),d=0;d<t.length;d++){var m=t[d];if(f=l,c=m.end,function(h,p,C){return p===""||!(h.length<p.length)&&h.substr(C,C+p.length)===p}(f,c,f.length-c.length)){var g=t.slice();g.splice(d,1);var b=zn(n,o,{pattern:m,remainingPatterns:g,position:i});if(b.isSome())return b}}return s.none()})},rt=function(n,t){if(!n.selection.isCollapsed())return!1;var e=Cn(n,t.inlinePatterns,!1),r=function(o,a){var i=o.dom,u=o.selection.getRng();return J(o,u).filter(function(f){var c=gn(o),l=c===""&&i.is(f,"body")||i.is(f,c);return f!==null&&l}).bind(function(f){var c=f.textContent;return Vn(a,c).map(function(l){return nt.trim(c).length===l.start.length?[]:[{pattern:l,range:X(i.getRoot(),f,0,f,0)}]})}).getOr([])}(n,t.blockPatterns);return(0<r.length||0<e.length)&&(n.undoManager.add(),n.undoManager.extra(function(){n.execCommand("mceInsertNewLine")},function(){n.insertContent("\uFEFF"),xn(n,e),Wn(n,r);var o=n.selection.getRng(),a=K(o.startContainer,o.startOffset,n.dom.getRoot());n.execCommand("mceInsertNewLine"),a.each(function(i){var u=i.container;u.data.charAt(i.offset-1)==="\uFEFF"&&(u.deleteData(i.offset-1,1),T(n.dom,u.parentNode,function(f){return f===n.dom.getRoot()}))})}),!0)},An=function(n,t){var e=Cn(n,t.inlinePatterns,!0);0<e.length&&n.undoManager.transact(function(){xn(n,e)})},ot=function(n,t){return En(n,t,function(e,r){return e.charCodeAt(0)===r.charCode})},at=function(n,t){return En(n,t,function(e,r){return e===r.keyCode&&Nn.modifierPressed(r)===!1})},it=function(n,t){var e=[",",".",";",":","!","?"],r=[32];n.on("keydown",function(o){o.keyCode!==13||Nn.modifierPressed(o)||rt(n,t.get())&&o.preventDefault()},!0),n.on("keyup",function(o){at(r,o)&&An(n,t.get())}),n.on("keypress",function(o){ot(e,o)&&$n.setEditorTimeout(n,function(){An(n,t.get())})})};(function(){jn.add("textpattern",function(t){var e=$(Un(t.settings));return it(t,e),Qn(e)})})()})(window);
