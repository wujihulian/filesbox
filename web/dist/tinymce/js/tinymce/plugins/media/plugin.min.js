(function(){"use strict";function ge(){}function x(e){return function(){return e}}function M(){return U}var z,ve=tinymce.util.Tools.resolve("tinymce.PluginManager"),g=function(){return(g=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var o in r=arguments[t])Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e}).apply(this,arguments)},_=x(!1),N=x(!0),U=(z={fold:function(e,r){return e()},is:_,isSome:_,isNone:N,getOr:J,getOrThunk:G,getOrDie:function(e){throw new Error(e||"error: getOrDie called on none.")},getOrNull:x(null),getOrUndefined:x(void 0),or:J,orThunk:G,map:M,each:ge,bind:M,exists:_,forall:N,filter:M,equals:B,equals_:B,toArray:function(){return[]},toString:x("none()")},Object.freeze&&Object.freeze(z),z);function B(e){return e.isNone()}function G(e){return e()}function J(e){return e}function k(e){return function(r){return function(t){if(t===null)return"null";var n=typeof t;return n=="object"&&(Array.prototype.isPrototypeOf(t)||t.constructor&&t.constructor.name==="Array")?"array":n=="object"&&(String.prototype.isPrototypeOf(t)||t.constructor&&t.constructor.name==="String")?"string":n}(r)===e}}function K(e,r){for(var t=0,n=e.length;t<n;t++)r(e[t],t)}function v(e,r){return Ae(e,r)?j.from(e[r]):j.none()}function Q(e){return function(r){return r?function(t){return t.replace(/px$/,"")}(r.style[e]):""}}function V(e){return function(r,t){r&&(r.style[e]=function(n){return/^[0-9.]+$/.test(n)?n+"px":n}(t))}}function E(e,r){if(e){for(var t=0;t<e.length;t++)if(r.indexOf(e[t].filter)!==-1)return e[t]}}function X(e){return W.getAttrib(e,"data-ephox-embed-iri")}function R(e,r){return function(t){var n=W.createFragment(t);return X(n.firstChild)!==""}(r)?function(t){var n=W.createFragment(t).firstChild;return{type:"ephox-embed-iri",source:X(n),altsource:"",poster:"",width:P.getMaxWidth(n),height:P.getMaxHeight(n)}}(r):function(t,n){var o={};return F({validate:!1,allow_conditional_comments:!0,start:function(a,c){if(o.source||a!=="param"||(o.source=c.map.movie),a!=="iframe"&&a!=="object"&&a!=="embed"&&a!=="video"&&a!=="audio"||(o.type||(o.type=a),o=y.extend(c.map,o)),a==="script"){var i=E(t,c.map.src);if(!i)return;o={type:"script",source:c.map.src,width:String(i.width),height:String(i.height)}}a==="source"&&(o.source?o.altsource||(o.altsource=c.map.src):o.source=c.map.src),a!=="img"||o.poster||(o.poster=c.map.src)}}).parse(n),o.source=o.source||o.src||o.data,o.altsource=o.altsource||"",o.poster=o.poster||"",o}(e,r)}function w(e,r){var t,n,o,a;for(t in r)if(o=""+r[t],e.map[t])for(n=e.length;n--;)(a=e[n]).name===t&&(o?(e.map[t]=o,a.value=o):(delete e.map[t],e.splice(n,1)));else o&&(e.push({name:t,value:o}),e.map[t]=o)}function be(e,r){var t=I.createFragment(e).firstChild;return P.setMaxWidth(t,r.width),P.setMaxHeight(t,r.height),function(n){var o=H();return F(o).parse(n),o.getContent()}(t.outerHTML)}function Y(e,r){var t=y.extend({},r);if(!t.source&&(y.extend(t,R(C(e),t.embed)),!t.source))return"";t.altsource||(t.altsource=""),t.poster||(t.poster=""),t.source=e.convertURL(t.source,"source"),t.altsource=e.convertURL(t.altsource,"source"),t.sourcemime=ue(t.source),t.altsourcemime=ue(t.altsource),t.poster=e.convertURL(t.poster,"poster");var n=function(i){var u=ze.filter(function(s){return s.regex.test(i)});return 0<u.length?y.extend({},u[0],{url:function(s,d){for(var l=function(b){var $=b.match(/^(https?:\/\/|www\.)(.+)$/i);return $&&1<$.length?$[1]==="www."?"https://":$[1]:"https://"}(d),m=s.regex.exec(d),f=l+s.url,h=function(b){f=f.replace("$"+b,function(){return m[b]?m[b]:""})},p=0;p<m.length;p++)h(p);return f.replace(/\?$/,"")}(u[0],i)}):null}(t.source);if(n&&(t.source=n.url,t.type=n.type,t.allowFullscreen=n.allowFullscreen,t.width=t.width||String(n.w),t.height=t.height||String(n.h)),t.embed)return q(t.embed,t,!0);var o=E(C(e),t.source);o&&(t.type="script",t.width=String(o.width),t.height=String(o.height));var a=Ce(e),c=Me(e);return t.width=t.width||"300",t.height=t.height||"150",y.each(t,function(i,u){t[u]=e.dom.encode(""+i)}),t.type==="iframe"?function(i){var u=i.allowFullscreen?' allowFullscreen="1"':"";return'<iframe src="'+i.source+'" width="'+i.width+'" height="'+i.height+'"'+u+"></iframe>"}(t):t.sourcemime==="application/x-shockwave-flash"?function(i){var u='<object data="'+i.source+'" width="'+i.width+'" height="'+i.height+'" type="application/x-shockwave-flash">';return i.poster&&(u+='<img src="'+i.poster+'" width="'+i.width+'" height="'+i.height+'" />'),u+="</object>"}(t):t.sourcemime.indexOf("audio")!==-1?function(i,u){return u?u(i):'<audio controls="controls" src="'+i.source+'">'+(i.altsource?`
<source src="`+i.altsource+'"'+(i.altsourcemime?' type="'+i.altsourcemime+'"':"")+` />
`:"")+"</audio>"}(t,a):t.type==="script"?function(i){return'<script src="'+i.source+'"></script>'}(t):function(i,u){return u?u(i):'<video width="'+i.width+'" height="'+i.height+'"'+(i.poster?' poster="'+i.poster+'"':"")+` controls="controls">
<source src="`+i.source+'"'+(i.sourcemime?' type="'+i.sourcemime+'"':"")+` />
`+(i.altsource?'<source src="'+i.altsource+'"'+(i.altsourcemime?' type="'+i.altsourcemime+'"':"")+` />
`:"")+"</video>"}(t,c)}function Z(e){return function(r){return Y(e,r)}}function A(e,r){var t=r?function(o,a){return v(a,o).bind(function(c){return v(c,"meta")})}(r,e).getOr({}):{},n=function(o,a,c){return function(i){function u(){return v(o,i)}function s(){return v(a,i)}function d(m){return v(m,"value").bind(function(f){return 0<f.length?j.some(f):j.none()})}var l;return(l={})[i]=(i===c?u().bind(function(m){return ie(m)?d(m).orThunk(s):s().orThunk(function(){return j.from(m)})}):s().orThunk(function(){return u().bind(function(m){return ie(m)?d(m):j.from(m)})})).getOr(""),l}}(e,t,r);return g(g(g(g(g({},n("source")),n("altsource")),n("poster")),n("embed")),function(o,a){var c={};return v(o,"dimensions").each(function(i){K(["width","height"],function(u){v(a,u).orThunk(function(){return v(i,u)}).each(function(s){return c[u]=s})})}),c}(e,t))}function T(e){var r=g(g({},e),{source:{value:v(e,"source").getOr("")},altsource:{value:v(e,"altsource").getOr("")},poster:{value:v(e,"poster").getOr("")}});return K(["width","height"],function(t){v(e,t).each(function(n){var o=r.dimensions||{};o[t]=n,r.dimensions=o})}),r}function ee(e){return function(r){var t=r&&r.msg?"Media embed handler error: "+r.msg:"Media embed handler threw unknown error.";e.notificationManager.open({type:"error",text:t})}}function te(e,r){return R(C(e),r)}function re(e,r){return function(t){if(xe(t.url)&&0<t.url.trim().length){var n=t.html,o=te(r,n),a=g(g({},o),{source:t.url,embed:n});e.setData(T(a))}}}function ne(e,r){var t=e.dom.select("img[data-mce-object]");e.insertContent(r),function(n,o){for(var a=n.dom.select("img[data-mce-object]"),c=0;c<o.length;c++)for(var i=a.length-1;0<=i;i--)o[c]===a[i]&&a.splice(i,1);n.selection.select(a[0])}(e,t),e.nodeChanged()}function we(e,r){var t,n=r.name;return(t=new S("img",1)).shortEnded=!0,pe(e,r,t),t.attr({width:r.attr("width")||"300",height:r.attr("height")||(n==="audio"?"30":"150"),style:r.attr("style"),src:fe.transparentSrc,"data-mce-object":n,class:"mce-object mce-object-"+n}),t}function ye(e,r){var t,n,o,a=r.name;return(t=new S("span",1)).attr({contentEditable:"false",style:r.attr("style"),"data-mce-object":a,class:"mce-preview-object mce-object-"+a}),pe(e,r,t),(n=new S(a,1)).attr({src:r.attr("src"),allowfullscreen:r.attr("allowfullscreen"),style:r.attr("style"),class:r.attr("class"),width:r.attr("width"),height:r.attr("height"),frameborder:"0"}),(o=new S("span",1)).attr("class","mce-shim"),t.append(n),t.append(o),t}function oe(e){for(;e=e.parent;)if(e.attr("data-ephox-embed-iri")||(r=e.attr("class"))&&/\btiny-pageembed\b/.test(r))return!0;var r;return!1}var L=function(e){function r(){return o}function t(a){return a(e)}var n=x(e),o={fold:function(a,c){return c(e)},is:function(a){return e===a},isSome:N,isNone:_,getOr:n,getOrThunk:n,getOrDie:n,getOrNull:n,getOrUndefined:n,or:r,orThunk:r,map:function(a){return L(a(e))},each:function(a){a(e)},bind:t,exists:t,forall:t,filter:function(a){return a(e)?o:U},toArray:function(){return[e]},toString:function(){return"some("+e+")"},equals:function(a){return a.is(e)},equals_:function(a,c){return a.fold(_,function(i){return c(e,i)})}};return o},j={some:L,none:M,from:function(e){return e==null?U:L(e)}},xe=k("string"),ie=k("object"),je=k("array"),Oe=k("function"),qe=Array.prototype.slice,Se=Array.prototype.push,ae=(Oe(Array.from)&&Array.from,function(e){function r(){return t}var t=e;return{get:r,set:function(n){t=n},clone:function(){return ae(r())}}}),_e=Object.hasOwnProperty,Ae=function(e,r){return _e.call(e,r)},C=function(e){return e.getParam("media_scripts")},Ce=function(e){return e.getParam("audio_template_callback")},Me=function(e){return e.getParam("video_template_callback")},ke=function(e){return e.getParam("media_live_embeds",!0)},Te=function(e){return e.getParam("media_filter_html",!0)},Fe=function(e){return e.getParam("media_url_resolver")},Pe=function(e){return e.getParam("media_alt_source",!0)},De=function(e){return e.getParam("media_poster",!0)},$e=function(e){return e.getParam("media_dimensions",!0)},y=tinymce.util.Tools.resolve("tinymce.util.Tools"),F=tinymce.util.Tools.resolve("tinymce.html.SaxParser"),ce=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),P={getMaxWidth:Q("maxWidth"),getMaxHeight:Q("maxHeight"),setMaxWidth:V("maxWidth"),setMaxHeight:V("maxHeight")},W=ce.DOM,ue=function(e){var r={mp3:"audio/mpeg",m4a:"audio/x-m4a",wav:"audio/wav",mp4:"video/mp4",webm:"video/webm",ogg:"video/ogg",swf:"application/x-shockwave-flash"}[e.toLowerCase().split(".").pop()];return r||""},H=tinymce.util.Tools.resolve("tinymce.html.Writer"),se=tinymce.util.Tools.resolve("tinymce.html.Schema"),I=ce.DOM,O=["source","altsource"],q=function(e,r,t){return function(n){var o=I.createFragment(n);return I.getAttrib(o.firstChild,"data-ephox-embed-iri")!==""}(e)?be(e,r):function(n,o,a){var c,i=H(),u=0;return F({validate:!1,allow_conditional_comments:!0,comment:function(s){i.comment(s)},cdata:function(s){i.cdata(s)},text:function(s,d){i.text(s,d)},start:function(s,d,l){switch(s){case"video":case"object":case"embed":case"img":case"iframe":o.height!==void 0&&o.width!==void 0&&w(d,{width:o.width,height:o.height})}if(a)switch(s){case"video":w(d,{poster:o.poster,src:""}),o.altsource&&w(d,{src:""});break;case"iframe":w(d,{src:o.source});break;case"source":if(u<2&&(w(d,{src:o[O[u]],type:o[O[u]+"mime"]}),!o[O[u]]))return;u++;break;case"img":if(!o.poster)return;c=!0}i.start(s,d,l)},end:function(s){if(s==="video"&&a){for(var d=0;d<2;d++)if(o[O[d]]){var l=[];l.map={},u<d&&(w(l,{src:o[O[d]],type:o[O[d]+"mime"]}),i.start("source",l,!0))}}if(o.poster&&s==="object"&&a&&!c){var m=[];m.map={},w(m,{src:o.poster,width:o.width,height:o.height}),i.start("img",m,!0)}i.end(s)}},se({})).parse(n),i.getContent()}(e,r,t)},ze=[{regex:/youtu\.be\/([\w\-_\?&=.]+)/i,type:"iframe",w:560,h:314,url:"www.youtube.com/embed/$1",allowFullscreen:!0},{regex:/youtube\.com(.+)v=([^&]+)(&([a-z0-9&=\-_]+))?/i,type:"iframe",w:560,h:314,url:"www.youtube.com/embed/$2?$4",allowFullscreen:!0},{regex:/youtube.com\/embed\/([a-z0-9\?&=\-_]+)/i,type:"iframe",w:560,h:314,url:"www.youtube.com/embed/$1",allowFullscreen:!0},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc",allowFullscreen:!0},{regex:/vimeo\.com\/(.*)\/([0-9]+)/,type:"iframe",w:425,h:350,url:"player.vimeo.com/video/$2?title=0&amp;byline=0",allowFullscreen:!0},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'maps.google.com/maps/ms?msid=$2&output=embed"',allowFullscreen:!1},{regex:/dailymotion\.com\/video\/([^_]+)/,type:"iframe",w:480,h:270,url:"www.dailymotion.com/embed/video/$1",allowFullscreen:!0},{regex:/dai\.ly\/([^_]+)/,type:"iframe",w:480,h:270,url:"www.dailymotion.com/embed/video/$1",allowFullscreen:!0}],le=tinymce.util.Tools.resolve("tinymce.util.Promise"),D={},me=function(e,r){var t=Fe(e);return t?function(n,o,a){return new le(function(c,i){function u(s){return s.html&&(D[n.source]=s),c({url:n.source,html:s.html?s.html:o(n)})}D[n.source]?u(D[n.source]):a({url:n.source},u,i)})}(r,Z(e),t):function(n,o){return new le(function(a){a({html:o(n),url:n.source})})}(r,Z(e))},Ne=function(e){return D.hasOwnProperty(e)},de=function(e){var r=function(l){var m=l.selection.getNode(),f=function(h){return h.getAttribute("data-mce-object")||h.getAttribute("data-ephox-embed-iri")}(m)?l.serializer.serialize(m,{selection:!0}):"";return g({embed:f},R(C(l),f))}(e),t=ae(r),n=T(r),o={title:"General",name:"general",items:function(l){for(var m=[],f=0,h=l.length;f<h;++f){if(!je(l[f]))throw new Error("Arr.flatten item "+f+" was not an array, input: "+l);Se.apply(m,l[f])}return m}([[{name:"source",type:"urlinput",filetype:"media",label:"Source"}],$e(e)?[{type:"sizeinput",name:"dimensions",label:"Constrain proportions",constrain:!0}]:[]])},a={title:"Embed",items:[{type:"textarea",name:"embed",label:"Paste your embed code below:"}]},c=[];Pe(e)&&c.push({name:"altsource",type:"urlinput",filetype:"media",label:"Alternative source URL"}),De(e)&&c.push({name:"poster",type:"urlinput",filetype:"image",label:"Media poster (Image URL)"});var i={title:"Advanced",name:"advanced",items:c},u=[o,a];0<c.length&&u.push(i);var s={type:"tabpanel",tabs:u},d=e.windowManager.open({title:"Insert/Edit Media",size:"normal",body:s,buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0}],onSubmit:function(l){var m=A(l.getData());(function(f,h,p){h.embed=q(h.embed,h),h.embed&&(f.source===h.source||Ne(h.source))?ne(p,h.embed):me(p,h).then(function(b){ne(p,b.html)}).catch(ee(p))})(t.get(),m,e),l.close()},onChange:function(l,m){switch(m.name){case"source":(function(f,h){var p=A(h.getData(),"source");f.source!==p.source&&(re(d,e)({url:p.source,html:""}),me(e,p).then(re(d,e)).catch(ee(e)))})(t.get(),l);break;case"embed":(function(f){var h=A(f.getData()),p=te(e,h.embed);f.setData(T(p))})(l);break;case"dimensions":case"altsource":case"poster":(function(f,h){var p=A(f.getData(),h),b=Y(e,p);f.setData(T(g(g({},p),{embed:b})))})(l,m.name)}t.set(A(l.getData()))},initialData:n})},Ue=function(e){return{showDialog:function(){de(e)}}},Ee=function(e){e.addCommand("mceMedia",function(){de(e)})},S=tinymce.util.Tools.resolve("tinymce.html.Node"),fe=tinymce.util.Tools.resolve("tinymce.Env"),he=function(e,r){if(Te(e)===!1)return r;var t,n=H();return F({validate:!1,allow_conditional_comments:!1,comment:function(o){n.comment(o)},cdata:function(o){n.cdata(o)},text:function(o,a){n.text(o,a)},start:function(o,a,c){if(t=!0,o!=="script"&&o!=="noscript"){for(var i=0;i<a.length;i++){if(a[i].name.indexOf("on")===0)return;a[i].name==="style"&&(a[i].value=e.dom.serializeStyle(e.dom.parseStyle(a[i].value),o))}n.start(o,a,c),t=!1}},end:function(o){t||n.end(o)}},se({})).parse(r),n.getContent()},pe=function(e,r,t){var n,o,a,c,i;for(c=(a=r.attributes).length;c--;)n=a[c].name,o=a[c].value,n!=="width"&&n!=="height"&&n!=="style"&&(n!=="data"&&n!=="src"||(o=e.convertURL(o,n)),t.attr("data-mce-p-"+n,o));(i=r.firstChild&&r.firstChild.value)&&(t.attr("data-mce-html",escape(he(e,i))),t.firstChild=null)},Re=function(e){return function(r){for(var t,n,o=r.length;o--;)(t=r[o]).parent&&(t.parent.attr("data-mce-object")||t.name==="script"&&!(n=E(C(e),t.attr("src")))||(n&&(n.width&&t.attr("width",n.width.toString()),n.height&&t.attr("height",n.height.toString())),t.name==="iframe"&&ke(e)&&fe.ceFalse?oe(t)||t.replace(ye(e,t)):oe(t)||t.replace(we(e,t))))}},Le=function(e){e.on("preInit",function(){var r=e.schema.getSpecialElements();y.each("video audio iframe object".split(" "),function(n){r[n]=new RegExp("</"+n+"[^>]*>","gi")});var t=e.schema.getBoolAttrs();y.each("webkitallowfullscreen mozallowfullscreen allowfullscreen".split(" "),function(n){t[n]={}}),e.parser.addNodeFilter("iframe,video,audio,object,embed,script",Re(e)),e.serializer.addAttributeFilter("data-mce-object",function(n,o){for(var a,c,i,u,s,d,l,m,f=n.length;f--;)if((a=n[f]).parent){for(l=a.attr(o),c=new S(l,1),l!=="audio"&&l!=="script"&&((m=a.attr("class"))&&m.indexOf("mce-preview-object")!==-1?c.attr({width:a.firstChild.attr("width"),height:a.firstChild.attr("height")}):c.attr({width:a.attr("width"),height:a.attr("height")})),c.attr({style:a.attr("style")}),i=(u=a.attributes).length;i--;){var h=u[i].name;h.indexOf("data-mce-p-")===0&&c.attr(h.substr(11),u[i].value)}l==="script"&&c.attr("type","text/javascript"),(s=a.attr("data-mce-html"))&&((d=new S("#text",3)).raw=!0,d.value=he(e,unescape(s)),c.append(d)),a.replace(c)}})}),e.on("SetContent",function(){e.$("span.mce-preview-object").each(function(r,t){var n=e.$(t);n.find("span.mce-shim").length===0&&n.append('<span class="mce-shim"></span>')})})},We=function(e){e.on("ResolveName",function(r){var t;r.target.nodeType===1&&(t=r.target.getAttribute("data-mce-object"))&&(r.name=t)})},He=function(e){e.on("click keyup touchend",function(){var r=e.selection.getNode();r&&e.dom.hasClass(r,"mce-preview-object")&&e.dom.getAttrib(r,"data-mce-selected")&&r.setAttribute("data-mce-selected","2")}),e.on("ObjectSelected",function(r){var t=r.target.getAttribute("data-mce-object");t!=="audio"&&t!=="script"||r.preventDefault()}),e.on("ObjectResized",function(r){var t,n=r.target;n.getAttribute("data-mce-object")&&(t=n.getAttribute("data-mce-html"))&&(t=unescape(t),n.setAttribute("data-mce-html",escape(q(t,{width:String(r.width),height:String(r.height)}))))})},Ie=function(e){e.ui.registry.addToggleButton("media",{tooltip:"Insert/edit media",icon:"embed",onAction:function(){e.execCommand("mceMedia")},onSetup:function(r,t){return function(n){return r.selection.selectorChangedWithUnbind(t.join(","),n.setActive).unbind}}(e,["img[data-mce-object]","span[data-mce-object]","div[data-ephox-embed-iri]"])}),e.ui.registry.addMenuItem("media",{icon:"embed",text:"Media...",onAction:function(){e.execCommand("mceMedia")}})};(function(){ve.add("media",function(r){return Ee(r),Ie(r),We(r),Le(r),He(r),Ue(r)})})()})();
