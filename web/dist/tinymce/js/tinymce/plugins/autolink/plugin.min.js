(function(){"use strict";function m(n,e){if(e<0&&(e=0),n.nodeType===3){var o=n.data.length;o<e&&(e=o)}return e}function a(n,e,o){e.nodeType!==1||e.hasChildNodes()?n.setStart(e,m(e,o)):n.setStartBefore(e)}function s(n,e,o){e.nodeType!==1||e.hasChildNodes()?n.setEnd(e,m(e,o)):n.setEndAfter(e)}var p=tinymce.util.Tools.resolve("tinymce.PluginManager"),w=tinymce.util.Tools.resolve("tinymce.Env"),v=function(n){return n.getParam("autolink_pattern",/^(https?:\/\/|ssh:\/\/|ftp:\/\/|file:\/|www\.|(?:mailto:)?[A-Z0-9._%+\-]+@)(.+)$/i)},S=function(n){return n.getParam("default_link_target",!1)},T=function(n){return n.getParam("link_default_protocol","http","string")},u=function(n,e,o){var t,r,l,i,y,g,f,d,h,c,O=v(n),k=S(n);if(n.selection.getNode().tagName!=="A"){if((t=n.selection.getRng(!0).cloneRange()).startOffset<5){if(!(d=t.endContainer.previousSibling)){if(!t.endContainer.firstChild||!t.endContainer.firstChild.nextSibling)return;d=t.endContainer.firstChild.nextSibling}if(h=d.length,a(t,d,h),s(t,d,h),t.endOffset<5)return;r=t.endOffset,i=d}else{if((i=t.endContainer).nodeType!==3&&i.firstChild){for(;i.nodeType!==3&&i.firstChild;)i=i.firstChild;i.nodeType===3&&(a(t,i,0),s(t,i,i.nodeValue.length))}r=t.endOffset===1?2:t.endOffset-1-e}for(l=r;a(t,i,2<=r?r-2:0),s(t,i,1<=r?r-1:0),r-=1,(c=t.toString())!==" "&&c!==""&&c.charCodeAt(0)!==160&&0<=r-2&&c!==o;);(function(C,b){return C===b||C===" "||C.charCodeAt(0)===160})(t.toString(),o)?(a(t,i,r),s(t,i,l),r+=1):(t.startOffset===0?a(t,i,0):a(t,i,r),s(t,i,l)),(g=t.toString()).charAt(g.length-1)==="."&&s(t,i,l-1),f=(g=t.toString().trim()).match(O);var _=T(n);f&&(f[1]==="www."?f[1]=_+"://www.":/@$/.test(f[1])&&!/^mailto:/.test(f[1])&&(f[1]="mailto:"+f[1]),y=n.selection.getBookmark(),n.selection.setRng(t),n.execCommand("createlink",!1,f[1]+f[2]),k!==!1&&n.dom.setAttrib(n.selection.getNode(),"target",k),n.selection.moveToBookmark(y),n.nodeChanged())}},A=function(n){var e;n.on("keydown",function(o){if(o.keyCode===13)return function(t){u(t,-1,"")}(n)}),w.browser.isIE()?n.on("focus",function(){if(!e){e=!0;try{n.execCommand("AutoUrlDetect",!1,!0)}catch(o){}}}):(n.on("keypress",function(o){if(o.keyCode===41)return function(t){u(t,-1,"(")}(n)}),n.on("keyup",function(o){if(o.keyCode===32)return function(t){u(t,0,"")}(n)}))};(function(){p.add("autolink",function(e){A(e)})})()})();
