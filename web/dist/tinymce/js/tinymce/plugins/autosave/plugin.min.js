(function(m){"use strict";function g(e,t){var r=e||t,n=/^(\d+)([ms]?)$/.exec(""+r);return(n[2]?{s:1e3,m:6e4}[n[2]]:1)*parseInt(r,10)}function c(e){var t=e.getParam("autosave_prefix","tinymce-autosave-{path}{query}{hash}-{id}-");return t=(t=(t=(t=t.replace(/\{path\}/g,m.document.location.pathname)).replace(/\{query\}/g,m.document.location.search)).replace(/\{hash\}/g,m.document.location.hash)).replace(/\{id\}/g,e.id)}function d(e,t){var r=e.settings.forced_root_block;return(t=h.trim(t===void 0?e.getBody().innerHTML:t))===""||new RegExp("^<"+r+"[^>]*>((\xA0|&nbsp;|[ 	]|<br[^>]*>)+?|)</"+r+">|<br>$","i").test(t)}function f(e){var t=parseInt(a.getItem(c(e)+"time"),10)||0;return!(new Date().getTime()-t>function(r){return g(r.settings.autosave_retention,"20m")}(e))||(v(e,!1),!1)}function y(e){var t=c(e);!d(e)&&e.isDirty()&&(a.setItem(t+"draft",e.getContent({format:"raw",no_events:!0})),a.setItem(t+"time",new Date().getTime().toString()),function(r){r.fire("StoreDraft")}(e))}function l(e){var t=c(e);f(e)&&(e.setContent(a.getItem(t+"draft"),{format:"raw"}),function(r){r.fire("RestoreDraft")}(e))}function w(e,t){var r=function(n){return g(n.settings.autosave_interval,"30s")}(e);t.get()||(R.setInterval(function(){e.removed||y(e)},r),t.set(!0))}function p(e){e.undoManager.transact(function(){l(e),v(e)}),e.focus()}var D=function(e){function t(){return r}var r=e;return{get:t,set:function(n){r=n},clone:function(){return D(t())}}},I=tinymce.util.Tools.resolve("tinymce.PluginManager"),R=tinymce.util.Tools.resolve("tinymce.util.Delay"),a=tinymce.util.Tools.resolve("tinymce.util.LocalStorage"),h=tinymce.util.Tools.resolve("tinymce.util.Tools"),v=function(e,t){var r=c(e);a.removeItem(r+"draft"),a.removeItem(r+"time"),t!==!1&&function(n){n.fire("RemoveDraft")}(e)};function u(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];return function(){for(var n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];var i=t.concat(n);return e.apply(null,i)}}function _(e,t){return function(r){r.setDisabled(!f(e));function n(){return r.setDisabled(!f(e))}return e.on("StoreDraft RestoreDraft RemoveDraft",n),function(){return e.off("StoreDraft RestoreDraft RemoveDraft",n)}}}var T=tinymce.util.Tools.resolve("tinymce.EditorManager");(function(){I.add("autosave",function(t){var r=D(!1);return function(n){n.editorManager.on("BeforeUnload",function(o){var i;h.each(T.get(),function(s){s.plugins.autosave&&s.plugins.autosave.storeDraft(),!i&&s.isDirty()&&function(b){return b.getParam("autosave_ask_before_unload",!0)}(s)&&(i=s.translate("You have unsaved changes are you sure you want to navigate away?"))}),i&&(o.preventDefault(),o.returnValue=i)})}(t),function(n,o){w(n,o),n.ui.registry.addButton("restoredraft",{tooltip:"Restore last draft",icon:"restore-draft",onAction:function(){p(n)},onSetup:_(n)}),n.ui.registry.addMenuItem("restoredraft",{text:"Restore last draft",icon:"restore-draft",onAction:function(){p(n)},onSetup:_(n)})}(t,r),t.on("init",function(){(function(n){return n.getParam("autosave_restore_when_empty",!1)})(t)&&t.dom.isEmpty(t.getBody())&&l(t)}),function(n){return{hasDraft:u(f,n),storeDraft:u(y,n),restoreDraft:u(l,n),removeDraft:u(v,n),isEmpty:u(d,n)}}(t)})})()})(window);
