layui.define("layer",function(I){"use strict";var r=layui.$,C=layui.layer,$=layui.hint(),p=layui.device(),b={config:{},set:function(e){var t=this;return t.config=r.extend({},t.config,e),t},on:function(e,t){return layui.onevent.call(this,A,e,t)}},T=function(){var e=this;return{upload:function(t){e.upload.call(e,t)},config:e.config}},A="upload",D="layui-upload-file",F="layui-upload-form",h="layui-upload-iframe",w="layui-upload-choose",f=function(e){var t=this;t.config=r.extend({},t.config,b.config,e),t.render()};f.prototype.config={accept:"images",exts:"",auto:!0,bindAction:"",url:"",field:"file",method:"post",data:{},drag:!0,size:0,number:0,multiple:!1},f.prototype.render=function(e){var t=this,e=t.config;e.elem=r(e.elem),e.bindAction=r(e.bindAction),t.file(),t.events()},f.prototype.file=function(){var e=this,t=e.config,s=e.elemFile=r(['<input class="'+D+'" type="file" accept="'+t.acceptMime+'" name="'+t.field+'"',t.multiple?" multiple":"",">"].join("")),i=t.elem.next();(i.hasClass(D)||i.hasClass(F))&&i.remove(),p.ie&&p.ie<10&&t.elem.wrap('<div class="layui-upload-wrap"></div>'),e.isFile()?(e.elemFile=t.elem,t.field=t.elem[0].name):t.elem.after(s),p.ie&&p.ie<10&&e.initIE()},f.prototype.initIE=function(){var e=this,t=e.config,s=r('<iframe id="'+h+'" class="'+h+'" name="'+h+'" frameborder="0"></iframe>'),i=r(['<form target="'+h+'" class="'+F+'" method="post" key="set-mine" enctype="multipart/form-data" action="'+t.url+'">',"</form>"].join(""));r("#"+h)[0]||r("body").append(s),t.elem.next().hasClass(F)||(e.elemFile.wrap(i),t.elem.next("."+F).append(function(){var n=[];return layui.each(t.data,function(l,c){c=typeof c=="function"?c():c,n.push('<input type="hidden" name="'+l+'" value="'+c+'">')}),n.join("")}()))},f.prototype.msg=function(e){return C.msg(e,{icon:2,shift:6})},f.prototype.isFile=function(){var e=this.config.elem[0];if(e)return e.tagName.toLocaleLowerCase()==="input"&&e.type==="file"},f.prototype.preview=function(e){var t=this;window.FileReader&&layui.each(t.chooseFiles,function(s,i){var n=new FileReader;n.readAsDataURL(i),n.onload=function(){e&&e(s,i,this.result)}})},f.prototype.upload=function(e,t){var s,i=this,n=i.config,l=i.elemFile[0],c=function(){var o=0,a=0,u=e||i.files||i.chooseFiles||l.files,g=function(){n.multiple&&o+a===i.fileLength&&typeof n.allDone=="function"&&n.allDone({total:i.fileLength,successful:o,aborted:a})};layui.each(u,function(z,B){var E=new FormData;E.append(n.field,B),layui.each(n.data,function(j,y){y=typeof y=="function"?y():y,E.append(j,y)}),r.ajax({url:n.url,type:"post",data:E,contentType:!1,processData:!1,dataType:"json",headers:n.headers||{},success:function(j){o++,k(z,j),g()},error:function(){a++,i.msg("\u8BF7\u6C42\u4E0A\u4F20\u63A5\u53E3\u51FA\u73B0\u5F02\u5E38"),L(z),g()}})})},d=function(){var o=r("#"+h);i.elemFile.parent().submit(),clearInterval(f.timer),f.timer=setInterval(function(){var a,u=o.contents().find("body");try{a=u.text()}catch(g){i.msg("\u83B7\u53D6\u4E0A\u4F20\u540E\u7684\u54CD\u5E94\u4FE1\u606F\u51FA\u73B0\u5F02\u5E38"),clearInterval(f.timer),L()}a&&(clearInterval(f.timer),u.html(""),k(0,a))},30)},k=function(o,a){if(i.elemFile.next("."+w).remove(),l.value="",typeof a!="object")try{a=JSON.parse(a)}catch(u){return a={},i.msg("\u8BF7\u5BF9\u4E0A\u4F20\u63A5\u53E3\u8FD4\u56DE\u6709\u6548JSON")}typeof n.done=="function"&&n.done(a,o||0,function(u){i.upload(u)})},L=function(o){n.auto&&(l.value=""),typeof n.error=="function"&&n.error(o||0,function(a){i.upload(a)})},v=n.exts,m=function(){var o=[];return layui.each(e||i.chooseFiles,function(a,u){o.push(u.name)}),o}(),R={preview:function(o){i.preview(o)},upload:function(o,a){var u={};u[o]=a,i.upload(u)},pushFile:function(){return i.files=i.files||{},layui.each(i.chooseFiles,function(o,a){i.files[o]=a}),i.files},resetFile:function(o,a,u){var g=new File([a],u);i.files=i.files||{},i.files[o]=g}},N=function(){if(t!=="choose"&&!n.auto||(n.choose&&n.choose(R),t!=="choose"))return n.before&&n.before(R),p.ie?p.ie>9?c():d():void c()};if(m=m.length===0?l.value.match(/[^\/\\]+\..+/g)||[]:m,m.length!==0){switch(n.accept){case"file":if(v&&!RegExp("\\w\\.("+v+")$","i").test(escape(m)))return i.msg("\u9009\u62E9\u7684\u6587\u4EF6\u4E2D\u5305\u542B\u4E0D\u652F\u6301\u7684\u683C\u5F0F"),l.value="";break;case"video":if(!RegExp("\\w\\.("+(v||"avi|mp4|wma|rmvb|rm|flash|3gp|flv")+")$","i").test(escape(m)))return i.msg("\u9009\u62E9\u7684\u89C6\u9891\u4E2D\u5305\u542B\u4E0D\u652F\u6301\u7684\u683C\u5F0F"),l.value="";break;case"audio":if(!RegExp("\\w\\.("+(v||"mp3|wav|mid")+")$","i").test(escape(m)))return i.msg("\u9009\u62E9\u7684\u97F3\u9891\u4E2D\u5305\u542B\u4E0D\u652F\u6301\u7684\u683C\u5F0F"),l.value="";break;default:if(layui.each(m,function(o,a){RegExp("\\w\\.("+(v||"jpg|png|gif|bmp|jpeg$")+")","i").test(escape(a))||(s=!0)}),s)return i.msg("\u9009\u62E9\u7684\u56FE\u7247\u4E2D\u5305\u542B\u4E0D\u652F\u6301\u7684\u683C\u5F0F"),l.value=""}if(i.fileLength=function(){var o=0,a=e||i.files||i.chooseFiles||l.files;return layui.each(a,function(){o++}),o}(),n.number&&i.fileLength>n.number)return i.msg("\u540C\u65F6\u6700\u591A\u53EA\u80FD\u4E0A\u4F20\u7684\u6570\u91CF\u4E3A\uFF1A"+n.number);if(n.size>0&&!(p.ie&&p.ie<10)){var x;if(layui.each(i.chooseFiles,function(o,a){if(a.size>1024*n.size){var u=n.size/1024;u=u>=1?u.toFixed(2)+"MB":n.size+"KB",l.value="",x=u}}),x)return i.msg("\u6587\u4EF6\u4E0D\u80FD\u8D85\u8FC7"+x)}N()}},f.prototype.events=function(){var e=this,t=e.config,s=function(n){e.chooseFiles={},layui.each(n,function(l,c){var d=new Date().getTime();e.chooseFiles[d+"-"+l]=c})},i=function(n,l){var c=e.elemFile,d=n.length>1?n.length+"\u4E2A\u6587\u4EF6":(n[0]||{}).name||c[0].value.match(/[^\/\\]+\..+/g)||[];c.next().hasClass(w)&&c.next().remove(),e.upload(null,"choose"),e.isFile()||t.choose||c.after('<span class="layui-inline '+w+'">'+d+"</span>")};t.elem.off("upload.start").on("upload.start",function(){var n=r(this),l=n.attr("lay-data");if(l)try{l=new Function("return "+l)(),e.config=r.extend({},t,l)}catch(c){$.error("Upload element property lay-data configuration item has a syntax error: "+l)}e.config.item=n,e.elemFile[0].click()}),p.ie&&p.ie<10||t.elem.off("upload.over").on("upload.over",function(){var n=r(this);n.attr("lay-over","")}).off("upload.leave").on("upload.leave",function(){var n=r(this);n.removeAttr("lay-over")}).off("upload.drop").on("upload.drop",function(n,l){var c=r(this),d=l.originalEvent.dataTransfer.files||[];c.removeAttr("lay-over"),s(d),t.auto?e.upload(d):i(d)}),e.elemFile.off("upload.change").on("upload.change",function(){var n=this.files||[];s(n),t.auto?e.upload():i(n)}),t.bindAction.off("upload.action").on("upload.action",function(){e.upload()}),t.elem.data("haveEvents")||(e.elemFile.on("change",function(){r(this).trigger("upload.change")}),t.elem.on("click",function(){e.isFile()||r(this).trigger("upload.start")}),t.drag&&t.elem.on("dragover",function(n){n.preventDefault(),r(this).trigger("upload.over")}).on("dragleave",function(n){r(this).trigger("upload.leave")}).on("drop",function(n){n.preventDefault(),r(this).trigger("upload.drop",n)}),t.bindAction.on("click",function(){r(this).trigger("upload.action")}),t.elem.data("haveEvents",!0))},b.render=function(e){var t=new f(e);return T.call(t)},I(A,b)});
